{"version":3,"sources":["../../src/services/authServices.ts"],"sourcesContent":["import { hash, compare } from \"bcrypt\";\nimport { sign } from \"jsonwebtoken\";\nimport { SECRET_KEY } from \"@/config/env\";\nimport { CreateUserDto } from \"@/dtos/userDto\";\nimport { HttpException } from \"@/exceptions/httpException\";\nimport { DataStoredInToken, TokenData } from \"@/interfaces/authInterface\";\nimport { User } from \"@/interfaces/userInterface\";\nimport userModel from \"@/models/User\";\nimport { isEmpty } from \"@utils/util\";\nimport any = jasmine.any;\n\n/**\n * Authorization, admin login va logout qilish bo'limi\n */\nclass AuthService {\n    public users = userModel;\n\n    public async login(userData: CreateUserDto): Promise<{ findUser: User; cookie: string; token: string }> {\n        if (isEmpty(userData)) throw new HttpException(400, \"CreateUserDto is empty\");\n\n        const findUser: User = await this.users\n            .findOne({ username: userData.username })\n            .select(\"-__v\");\n        if (!findUser)\n            throw new HttpException(409, `This username ${userData.username} was not found`);\n\n        const isPasswordMatching: boolean = await compare(userData.password, findUser.password);\n        if (!isPasswordMatching) throw new HttpException(409, \"Password is not matching\");\n\n        const tokenData = this.createToken(findUser);\n        const token: string = this.createToken(findUser).token;\n        const cookie = this.createCookie(tokenData);\n\n        return { cookie, findUser, token };\n    }\n\n    public async logout(userData: User): Promise<User> {\n        if (isEmpty(userData)) throw new HttpException(400, \"adminData is empty\");\n\n        const findUser: User = await this.users\n            .findOne({\n                username: userData.username,\n                password: userData.password\n            })\n            .select(\"-__v -password\");\n        if (!findUser)\n            throw new HttpException(409, `This username ${userData.username} was not found`);\n\n        return findUser;\n    }\n\n    public createToken(user: User): TokenData {\n        const dataStoredInToken: DataStoredInToken = { _id: user._id };\n        const secretKey: string = SECRET_KEY;\n        const expiresIn: number = (60 * 60) * 20;\n\n        return { expiresIn, token: sign(dataStoredInToken, secretKey, { expiresIn }) };\n    }\n\n    public createCookie(tokenData: TokenData): string {\n        return `Authorization=${tokenData.token}; HttpOnly; Max-Age=${tokenData.expiresIn};`;\n    }\n}\n\nexport default AuthService;"],"names":["AuthService","login","userData","isEmpty","HttpException","findUser","users","findOne","username","select","isPasswordMatching","compare","password","tokenData","createToken","token","cookie","createCookie","logout","user","dataStoredInToken","_id","secretKey","SECRET_KEY","expiresIn","sign","userModel"],"mappings":";;;;+BAgEA;;aAAA;;wBAhE8B;8BACT;qBACM;+BAEG;+CAGR;sBACE;;;;;;;;;;;;;;;;;;;AAMxB,IAAA,AAAMA,cAAN,MAAMA;IAGF,MAAaC,MAAMC,QAAuB,EAA8D;QACpG,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK,0BAA0B;QAE9E,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAClCC,OAAO,CAAC;YAAEC,UAAUN,SAASM,QAAQ;QAAC,GACtCC,MAAM,CAAC;QACZ,IAAI,CAACJ,UACD,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,cAAc,EAAEF,SAASM,QAAQ,CAAC,cAAc,CAAC,EAAE;QAErF,MAAME,qBAA8B,MAAMC,IAAAA,eAAO,EAACT,SAASU,QAAQ,EAAEP,SAASO,QAAQ;QACtF,IAAI,CAACF,oBAAoB,MAAM,IAAIN,4BAAa,CAAC,KAAK,4BAA4B;QAElF,MAAMS,YAAY,IAAI,CAACC,WAAW,CAACT;QACnC,MAAMU,QAAgB,IAAI,CAACD,WAAW,CAACT,UAAUU,KAAK;QACtD,MAAMC,SAAS,IAAI,CAACC,YAAY,CAACJ;QAEjC,OAAO;YAAEG;YAAQX;YAAUU;QAAM;IACrC;IAEA,MAAaG,OAAOhB,QAAc,EAAiB;QAC/C,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK,sBAAsB;QAE1E,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAClCC,OAAO,CAAC;YACLC,UAAUN,SAASM,QAAQ;YAC3BI,UAAUV,SAASU,QAAQ;QAC/B,GACCH,MAAM,CAAC;QACZ,IAAI,CAACJ,UACD,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,cAAc,EAAEF,SAASM,QAAQ,CAAC,cAAc,CAAC,EAAE;QAErF,OAAOH;IACX;IAEOS,YAAYK,IAAU,EAAa;QACtC,MAAMC,oBAAuC;YAAEC,KAAKF,KAAKE,GAAG;QAAC;QAC7D,MAAMC,YAAoBC,eAAU;QACpC,MAAMC,YAAoB,AAAC,KAAK,KAAM;QAEtC,OAAO;YAAEA;YAAWT,OAAOU,IAAAA,kBAAI,EAACL,mBAAmBE,WAAW;gBAAEE;YAAU;QAAG;IACjF;IAEOP,aAAaJ,SAAoB,EAAU;QAC9C,OAAO,CAAC,cAAc,EAAEA,UAAUE,KAAK,CAAC,oBAAoB,EAAEF,UAAUW,SAAS,CAAC,CAAC,CAAC;IACxF;;QA9CA,uBAAOlB,SAAQoB,aAAS;;AA+C5B;MAEA,WAAe1B"}